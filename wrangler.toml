// Cloudflare Worker Integration Example: KV Storage and AI Search (AutoRAG)

// Assuming the Env interface (or TypeScript type) includes KV and AI_RAG bindings:
// interface Env {
//   COMMENTS_KV: KVNamespace; // Your KV binding
//   RAG_AI: AISearch;         // Your AI Search binding (AutoRAG)
// }

export default {
    /**
     * @param {Request} request
     * @param {Env} env - The environment object containing all bindings
     * @param {ExecutionContext} ctx
     */
    async fetch(request, env, ctx) {
        const url = new URL(request.url);
        const path = url.pathname;

        // --- Route 1: KV Namespace Operations Example ---
        if (path.startsWith('/kv')) {
            // The KV binding name comes from wrangler.toml; we use COMMENTS_KV
            const kv = env.COMMENTS_KV;

            // 1. Write a Key-Value Pair
            // KV storage is used for quick access to unstructured data like comments, settings, or counters
            await kv.put('example_key', 'KV Storage data from Skyroute Enterprise');

            // 2. Read the Key-Value Pair
            const value = await kv.get('example_key');

            // 3. List all Keys
            // Note: kv.list() returns an object containing a .keys array
            const allKeys = await kv.list();

            // 4. Delete the Key (Omitted to avoid deletion on every write, but kept as example)
            // await kv.delete('example_key'); 

            return new Response(
                JSON.stringify({
                    message: "KV operations complete (written, read, and listed)",
                    retrieved_value: value,
                    all_keys_in_namespace: allKeys.keys,
                }, null, 2),
                { 
                    headers: { 'Content-Type': 'application/json' },
                    status: 200
                }
            );
        }

        // --- Route 2: AI Search (AutoRAG) Operations Example ---
        if (path.startsWith('/search')) {
            // Get the user-provided query
            const userQuery = url.searchParams.get('q');
            
            if (!userQuery) {
                return new Response("Please provide a query parameter (e.g., /search?q=your question...)", { status: 400 });
            }

            try {
                // RAG_AI is the binding name we set for rough-smoke-b49b in wrangler.toml
                // The .search() method handles retrieval, answer generation, and source citation
                const ragResults = await env.RAG_AI.search({
                    query: userQuery,
                    limit: 3, // Limit retrieval to 3 source snippets
                });

                const responseData = {
                    query: userQuery,
                    // AI model generated summary answer
                    answer: ragResults.answer, 
                    // Retrieved source snippets, used to ground the answer
                    sources: ragResults.snippets.map(s => ({
                        text: s.text,
                        // Optional: metadata may contain filename, URL, or other identifying info
                        // metadata: s.metadata 
                    })), 
                };

                return new Response(JSON.stringify(responseData, null, 2), {
                    headers: { 'Content-Type': 'application/json' },
                    status: 200
                });

            } catch (error) {
                // In a real deployment, you may need more granular error handling
                console.error("AI Search call failed:", error);
                return new Response(
                    JSON.stringify({ error: `AI Search failed: ${error instanceof Error ? error.message : 'Unknown error'}` }),
                    { headers: { 'Content-Type': 'application/json' }, status: 500 }
                );
            }
        }

        // --- Default Route ---
        return new Response("Welcome to the Skyroute Enterprise Worker. Visit /kv for KV test or /search?q=... for AI Search test.", { status: 200 });
    }
}
