---
import BaseLayout from '@layouts/BaseLayout.astro';
import CommentBox from '@components/CommentBox.astro';
import { getWorkBySlug } from '@lib/works';

const { slug } = Astro.params;
const work = slug ? getWorkBySlug(slug) : undefined;

if (!work) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}
---
<BaseLayout title={work.title} description={work.summary} ogImage={work.thumbnail}>
  <article class="mx-auto max-w-4xl px-6 py-16 text-white">
    <header class="space-y-4">
      <span data-pill>{new Date(work.publishedAt).toLocaleDateString(undefined, { month: 'long', year: 'numeric' })}</span>
      <h1 class="text-4xl font-bold leading-tight sm:text-5xl">{work.title}</h1>
      <p class="text-base text-slate-300">{work.summary}</p>
      <div class="flex flex-wrap items-center gap-3 text-xs font-semibold uppercase tracking-[0.3em] text-white/60">
        <span>Duration {work.duration}</span>
        {work.client && <span>Client {work.client}</span>}
      </div>
      <ul class="flex flex-wrap gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/60">
        {work.tags.map((tag) => (
          <li class="rounded-full border border-white/20 px-3 py-1" data-tag={tag}>
            {tag}
          </li>
        ))}
      </ul>
    </header>

    <div class="mt-10 overflow-hidden rounded-3xl border border-white/10 bg-black/40 shadow-2xl">
      <video
        class="lazy-video h-full w-full"
        controls
        playsinline
        poster={work.thumbnail}
        preload="none"
        data-src={work.videoUrl}
      >
        <source data-src={work.videoUrl} type="video/mp4" />
        Your browser does not support the video tag.
      </video>
    </div>

    <div class="prose prose-invert prose-p:text-slate-300 mt-10 max-w-none">
      <p>{work.description}</p>
    </div>

    <CommentBox postId={`work-${work.slug}`} />
  </article>
</BaseLayout>

<script type="module" astro:load>
  const lazyVideos = document.querySelectorAll('video.lazy-video');
  const loadVideo = (video) => {
    const source = video.querySelector('source[data-src]');
    if (source && !source.src) {
      source.src = source.dataset.src;
    }
    if (!video.src) {
      video.src = video.dataset.src ?? '';
    }
    video.load();
  };

  const observer = new IntersectionObserver(
    (entries, obs) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const video = entry.target;
          loadVideo(video);
          obs.unobserve(video);
        }
      });
    },
    { rootMargin: '200px' }
  );

  lazyVideos.forEach((video) => observer.observe(video));
</script>
